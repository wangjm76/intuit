<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TradieBidService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tradie-bid</a> &gt; <a href="index.source.html" class="el_package">com.intuit.tradieBid.service</a> &gt; <span class="el_source">TradieBidService.java</span></div><h1>TradieBidService.java</h1><pre class="source lang-java linenums">package com.intuit.tradieBid.service;

import com.intuit.tradieBid.entity.Bid;
import com.intuit.tradieBid.entity.Customer;
import com.intuit.tradieBid.entity.Job;
import com.intuit.tradieBid.entity.Tradie;
import com.intuit.tradieBid.exception.InvalidBidException;
import com.intuit.tradieBid.exception.NoMoreBidException;
import com.intuit.tradieBid.exception.NoWinningBidException;
import com.intuit.tradieBid.exception.NotFoundException;
import com.intuit.tradieBid.model.WinningBid;
import com.intuit.tradieBid.repository.BidRepository;
import com.intuit.tradieBid.repository.CustomerRepository;
import com.intuit.tradieBid.repository.JobRepository;
import com.intuit.tradieBid.repository.TradieRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler;
import org.springframework.stereotype.Service;
import org.springframework.util.ObjectUtils;

import javax.annotation.PostConstruct;
import java.time.Instant;
import java.time.OffsetDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Service
public class TradieBidService {
    private final CustomerRepository customerRepository;
    private final TradieRepository tradieRepository;
    private final JobRepository jobRepository;
    private final BidRepository bidRepository;
    private final ThreadPoolTaskScheduler threadPoolTaskScheduler;
    private final ComputeWinningBidService computeWinningBidService;

<span class="fc" id="L37">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span>

<span class="fc" id="L39">    public TradieBidService(CustomerRepository customerRepository, TradieRepository tradieRepository, JobRepository jobRepository, BidRepository bidRepository, ThreadPoolTaskScheduler threadPoolTaskScheduler, ComputeWinningBidService computeWinningBidService) {</span>
<span class="fc" id="L40">        this.customerRepository = customerRepository;</span>
<span class="fc" id="L41">        this.tradieRepository = tradieRepository;</span>
<span class="fc" id="L42">        this.jobRepository = jobRepository;</span>
<span class="fc" id="L43">        this.bidRepository = bidRepository;</span>
<span class="fc" id="L44">        this.threadPoolTaskScheduler = threadPoolTaskScheduler;</span>
<span class="fc" id="L45">        this.computeWinningBidService = computeWinningBidService;</span>
<span class="fc" id="L46">    }</span>


    // in case app restarts, we want to reschedule jobs that are without a winning bid
    @PostConstruct
    public void scheduleAllUncompletedJobs() {
<span class="fc" id="L52">        logger.info(&quot;schedule all uncompleted jobs&quot;);</span>
<span class="fc" id="L53">        final List&lt;Job&gt; jobs = jobRepository.findUncompletedJobs();</span>

<span class="fc bfc" id="L55" title="All 2 branches covered.">        if (!jobs.isEmpty()) {</span>
<span class="fc" id="L56">            final List&lt;Bid&gt; bids = bidRepository.findAllByJobId(jobs.get(0).getJobId());</span>
        }
<span class="fc" id="L58">        jobRepository.findUncompletedJobs().forEach(this::scheduleProcessWinningBid);</span>
<span class="fc" id="L59">    }</span>

    public Customer createCustomer(Customer customer) {
<span class="fc" id="L62">        return customerRepository.save(customer);</span>
    }


    public Customer findCustomer(Integer customerId) {
<span class="fc" id="L67">        return customerRepository.findByCustomerId(customerId);</span>
    }

    public Tradie createTradie(Tradie tradie) {
<span class="fc" id="L71">        return tradieRepository.save(tradie);</span>
    }

    public Tradie findTradie(Integer tradieId) {
<span class="fc" id="L75">        return tradieRepository.findByTradieId(tradieId);</span>
    }

    public Job createJob(Job job) {
<span class="fc" id="L79">        final Job savedJob = jobRepository.save(job);</span>
<span class="fc" id="L80">        scheduleProcessWinningBid(savedJob);</span>
<span class="fc" id="L81">        return savedJob;</span>
    }

    public Job findJob(Integer jobId) {
<span class="fc" id="L85">        return jobRepository.findByJobId(jobId);</span>
    }

    public Bid createBid(Bid bid) {
<span class="fc" id="L89">        final Job job = jobRepository.findByJobId(bid.getJobId());</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (ObjectUtils.isEmpty(job)) {</span>
<span class="fc" id="L91">            throw new NotFoundException();</span>
        }
        // bid after job is expired is not allowed
<span class="fc bfc" id="L94" title="All 2 branches covered.">        if (job.getToBeBiddenBy().isBefore(OffsetDateTime.now())) {</span>
<span class="fc" id="L95">            throw new NoMoreBidException();</span>
        }
        // bid should have either fix price or hourly rate
<span class="pc bpc" id="L98" title="1 of 4 branches missed.">        if ((ObjectUtils.isEmpty(bid.getFixedPrice()) &amp;&amp; ObjectUtils.isEmpty(bid.getHourlyRate())) ||</span>
<span class="fc bfc" id="L99" title="All 4 branches covered.">                !ObjectUtils.isEmpty(bid.getFixedPrice()) &amp;&amp; !ObjectUtils.isEmpty(bid.getHourlyRate())) {</span>
<span class="fc" id="L100">            throw new InvalidBidException();</span>
        }
<span class="fc" id="L102">        return bidRepository.save(bid);</span>
    }

    public Bid findBid(Integer bidId) {
<span class="fc" id="L106">        return bidRepository.findByBidId(bidId);</span>
    }

    public WinningBid getWinningBid(Integer jobId) {

<span class="fc" id="L111">        final Job job = jobRepository.findByJobId(jobId);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (ObjectUtils.isEmpty(job)) {</span>
<span class="fc" id="L113">            throw new NotFoundException();</span>
        }
<span class="fc bfc" id="L115" title="All 4 branches covered.">        if (ObjectUtils.isEmpty(job.getWinningBidId()) || job.getWinningBidId() == -1) {</span>
<span class="fc" id="L116">            throw new NoWinningBidException();</span>
        }
<span class="fc" id="L118">        final Bid winningBid = bidRepository.findByBidId(job.getWinningBidId());</span>
<span class="fc" id="L119">        final Tradie tradie = tradieRepository.findByTradieId(winningBid.getTradieId());</span>
<span class="fc" id="L120">        final Customer customer = customerRepository.findByCustomerId(job.getCustomerId());</span>

<span class="fc" id="L122">        return new WinningBid(</span>
<span class="fc" id="L123">                job.getJobId(),</span>
<span class="fc" id="L124">                job.getDescription(),</span>
<span class="fc" id="L125">                winningBid.getCost(job.getExpectedHours()),</span>
                customer,
                tradie
        );
    }

    public void scheduleProcessWinningBid(Job job) {
<span class="fc" id="L132">        logger.info(&quot;schedule computing winnning bid for job:[jobId:&quot; + job.getJobId() + &quot;] at&quot; + job.getToBeBiddenBy().format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));</span>
<span class="fc" id="L133">        threadPoolTaskScheduler.schedule(computeWinningBidService.createTask(job), Instant.parse(job.getToBeBiddenBy().format(DateTimeFormatter.ISO_OFFSET_DATE_TIME)));</span>
<span class="fc" id="L134">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>